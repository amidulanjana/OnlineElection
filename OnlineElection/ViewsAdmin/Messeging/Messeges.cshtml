@{
    ViewData["Title"] = "Messeging";
    Layout = "~/ViewsAdmin/Shared/_AdminLayout.cshtml";
}


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

<input type="text" id="conversationID" hidden value="@ViewBag.MessegeID" />





<div id="messListDown" style="overflow-y: scroll; height:80vh">

    @*<ul id="MessList" class="dropdown-menu list-unstyled msg_list" role="menu" >



    </ul>*@
    @*Used to load Messeges*@
</div>

<div id="ConversationView" style="overflow-y: scroll; height:80vh">
    <div class="col-md-12">
        <button type="submit" id="btnBack">Back</button>
    </div>


    <div id="fullConv">
        No Messege Selected
        @*<ul id="ConvList" class="dropdown-menu list-unstyled msg_list" role="menu" style="width:100%">



        </ul>*@
        @*Used to load Conversations*@
    </div>


</div>




<script type="text/javascript">
    if ($(window).width() >= 992) {
        $('#messListDown').attr("class", "col-lg-3");
        $('#fullConv').attr("class", "col-lg-9");
        $('#btnBack').hide();
    }
    else if ($(window).width() >= 768) {
        $('#messListDown').attr("class", "col-md-3");
        $('#fullConv').attr("class", "col-md-9");
        $('#btnBack').hide();
    }
    else if ($(window).width() >= 544) {
        $('#messListDown').attr("class", "col-sm-12");
        $('#ConversationView').hide();
    }
    else {
        $('#messListDown').attr("class", "col-xs-12");
        $('#ConversationView').hide();
    }



    $('#btnBack').click(function () {
        //alert("clicked");
        $('#ConversationView').hide();
        $('#messListDown').show();
    });
</script>









@*Signal R messeging Scripts*@

@section Scripts{
    <script src="/Scripts/jquery.signalR-2.1.1.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
    <script type="text/javascript">

        var tbl = $('#fullConv');
        var ID = $('#conversationID').val();
        //alert(ID);

        if ($(window).width() >= 768) {

            $.ajax({
                url: 'GetMessConvView',
                contentType: 'application/html ; charset:utf-8',
                data: "id=" + ID,
                type: 'GET',
                dataType: 'html'
            }).success(function (result) {
                tbl.empty().append(result);
            }).error(function (xhr, status, error) {
                var err = eval("(" + xhr.responseText + ")");
                alert(err.Message);
            });

        }
        else {
            if (ID != null) {
                $.ajax({
                    url: 'GetMessConvView',
                    contentType: 'application/html ; charset:utf-8',
                    data: "id=" + ID,
                    type: 'GET',
                    dataType: 'html'
                }).success(function (result) {
                    tbl.empty().append(result);
                    $('#ConversationView').show();
                    $('#messListDown').hide();
                }).error(function (xhr, status, error) {
                    var err = eval("(" + xhr.responseText + ")");
                    alert(err.Message);
                });
            }
            else {
                $('#ConversationView').hide();
                $('#messListDown').show();
            }
        }

















        var i = 0;
    $(function () {
        // Declare a proxy to reference the hub.
        var notifications = $.connection.messagesHub;

        //debugger;
        // Create a function that the hub can call to broadcast messages.
        notifications.client.updateMessages = function () {
            if (i == 0) {
                getAllMessages();
                getAllMess();
                resetI();
            }
            i++;

        };
        // Start the connection.
        $.connection.hub.start().done(function () {
            alert("connection started")
            getAllMessages();
            getAllMess();
        }).fail(function (e) {
            alert(e);
        });
    });

    function resetI() {
        setTimeout(function () {

            i = 0;
        }, 3000);
    }

    function getAllMessages()
    {
        var tbl = $('#messagesTable');
        $.ajax({
            url: '../home/GetMessages',
            contentType: 'application/html ; charset:utf-8',
            type: 'GET',
            dataType: 'html'
        }).success(function (result) {
            tbl.empty().append(result);
        }).error(function (xhr, ajaxOptions, thrownError) {

            alert(xhr.status);
            alert(thrownError);
            alert(xhr.responseText);

        });
    }
    function getAllMess() {
        var tbl = $('#messListDown');
        $.ajax({
            url: 'GetMessView',
            contentType: 'application/html ; charset:utf-8',
            type: 'GET',
            dataType: 'html'
        }).success(function (result) {
            tbl.empty().append(result);
        }).error(function () {

        });
    }
    </script>
}


